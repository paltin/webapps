<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Практика хираганы — слоговые тренажёры</title>
  <link rel="stylesheet" href="./css/hiragana.css">
</head>
<body>
  <a class="home-button" href="index.html">Назад</a>
  <div class="wrap">
    <div class="card">
      <div id="rows" class="rows" aria-live="polite"></div>
      <div class="controls">
        <input id="answer" type="text" autocomplete="off" spellcheck="false" placeholder="Введите ромадзи" />
      </div>
    </div>
  </div>

  <button id="openAlphabet" class="fab alphabet-btn" title="Выбор слогов">あ+</button>
  <button id="openSettings" class="fab settings-btn" title="Настройки">⚙</button>
  <button id="regenBtn" class="fab regen-btn" title="Новый набор">↻</button>

  <aside id="alphabetPanel" class="panel alphabet-panel" aria-hidden="true">
    <header>
      <strong>Выбор слогов для тренировки</strong>
      <button id="closeAlphabet" class="btn ghost" type="button">Закрыть</button>
    </header>
    <div class="content">
      <div class="select-toolbar">
        <button id="selectAllBtn" class="btn ghost" type="button">Выбрать все</button>
        <button id="deselectAllBtn" class="btn ghost" type="button">Снять все</button>
        <button id="resetAlphabet" class="btn ghost" type="button">По умолчанию</button>
      </div>
      <div id="hiraganaGrid" class="kana-grid"></div>
    </div>
    <div class="actions">
      <button id="applyAlphabet" class="btn" type="button">Применить выбранные</button>
    </div>
  </aside>

  <aside id="panel" class="panel" aria-hidden="true">
    <header>
      <strong>Настройки тренировки</strong>
      <button id="closeSettings" class="btn ghost" type="button">Закрыть</button>
    </header>
    <div class="content">
      <div class="field">
        <label for="rowsCount">Количество строк</label>
        <input id="rowsCount" class="num" type="number" min="1" max="10" value="1">
      </div>
      <div class="field">
        <label for="lenPerRow">Символов в строке</label>
        <input id="lenPerRow" class="num" type="number" min="1" max="20" value="7">
      </div>
      <div class="field">
        <label for="kanaSize">Размер символов</label>
        <input id="kanaSize" type="range" min="24" max="120" value="50">
      </div>
    </div>
    <div class="actions">
      <button id="applySettings" class="btn" type="button">Применить</button>
      <button id="resetSettings" class="btn ghost" type="button">Сбросить</button>
    </div>
  </aside>

  <div id="backdrop" class="backdrop" aria-hidden="true"></div>

  <script>
    (function () {
      const HIRAGANA_DATA = [
        { symbol: 'あ', romaji: 'a', group: 'base' },
        { symbol: 'い', romaji: 'i', group: 'base' },
        { symbol: 'う', romaji: 'u', group: 'base' },
        { symbol: 'え', romaji: 'e', group: 'base' },
        { symbol: 'お', romaji: 'o', group: 'base' },
        { symbol: 'か', romaji: 'ka', group: 'base' },
        { symbol: 'き', romaji: 'ki', group: 'base' },
        { symbol: 'く', romaji: 'ku', group: 'base' },
        { symbol: 'け', romaji: 'ke', group: 'base' },
        { symbol: 'こ', romaji: 'ko', group: 'base' },
        { symbol: 'さ', romaji: 'sa', group: 'base' },
        { symbol: 'し', romaji: 'shi', group: 'base' },
        { symbol: 'す', romaji: 'su', group: 'base' },
        { symbol: 'せ', romaji: 'se', group: 'base' },
        { symbol: 'そ', romaji: 'so', group: 'base' },
        { symbol: 'た', romaji: 'ta', group: 'base' },
        { symbol: 'ち', romaji: 'chi', group: 'base' },
        { symbol: 'つ', romaji: 'tsu', group: 'base' },
        { symbol: 'て', romaji: 'te', group: 'base' },
        { symbol: 'と', romaji: 'to', group: 'base' },
        { symbol: 'な', romaji: 'na', group: 'base' },
        { symbol: 'に', romaji: 'ni', group: 'base' },
        { symbol: 'ぬ', romaji: 'nu', group: 'base' },
        { symbol: 'ね', romaji: 'ne', group: 'base' },
        { symbol: 'の', romaji: 'no', group: 'base' },
        { symbol: 'は', romaji: 'ha', group: 'base' },
        { symbol: 'ひ', romaji: 'hi', group: 'base' },
        { symbol: 'ふ', romaji: 'fu', group: 'base' },
        { symbol: 'へ', romaji: 'he', group: 'base' },
        { symbol: 'ほ', romaji: 'ho', group: 'base' },
        { symbol: 'ま', romaji: 'ma', group: 'base' },
        { symbol: 'み', romaji: 'mi', group: 'base' },
        { symbol: 'む', romaji: 'mu', group: 'base' },
        { symbol: 'め', romaji: 'me', group: 'base' },
        { symbol: 'も', romaji: 'mo', group: 'base' },
        { symbol: 'や', romaji: 'ya', group: 'base' },
        { symbol: 'ゆ', romaji: 'yu', group: 'base' },
        { symbol: 'よ', romaji: 'yo', group: 'base' },
        { symbol: 'ら', romaji: 'ra', group: 'base' },
        { symbol: 'り', romaji: 'ri', group: 'base' },
        { symbol: 'る', romaji: 'ru', group: 'base' },
        { symbol: 'れ', romaji: 're', group: 'base' },
        { symbol: 'ろ', romaji: 'ro', group: 'base' },
        { symbol: 'わ', romaji: 'wa', group: 'base' },
        { symbol: 'を', romaji: 'wo', group: 'base' },
        { symbol: 'ん', romaji: 'n', group: 'base' },
        { symbol: 'が', romaji: 'ga', group: 'dakuten' },
        { symbol: 'ぎ', romaji: 'gi', group: 'dakuten' },
        { symbol: 'ぐ', romaji: 'gu', group: 'dakuten' },
        { symbol: 'げ', romaji: 'ge', group: 'dakuten' },
        { symbol: 'ご', romaji: 'go', group: 'dakuten' },
        { symbol: 'ざ', romaji: 'za', group: 'dakuten' },
        { symbol: 'じ', romaji: 'ji', group: 'dakuten' },
        { symbol: 'ず', romaji: 'zu', group: 'dakuten' },
        { symbol: 'ぜ', romaji: 'ze', group: 'dakuten' },
        { symbol: 'ぞ', romaji: 'zo', group: 'dakuten' },
        { symbol: 'だ', romaji: 'da', group: 'dakuten' },
        { symbol: 'ぢ', romaji: 'ji', group: 'dakuten' },
        { symbol: 'づ', romaji: 'zu', group: 'dakuten' },
        { symbol: 'で', romaji: 'de', group: 'dakuten' },
        { symbol: 'ど', romaji: 'do', group: 'dakuten' },
        { symbol: 'ば', romaji: 'ba', group: 'dakuten' },
        { symbol: 'び', romaji: 'bi', group: 'dakuten' },
        { symbol: 'ぶ', romaji: 'bu', group: 'dakuten' },
        { symbol: 'べ', romaji: 'be', group: 'dakuten' },
        { symbol: 'ぼ', romaji: 'bo', group: 'dakuten' },
        { symbol: 'ぱ', romaji: 'pa', group: 'dakuten' },
        { symbol: 'ぴ', romaji: 'pi', group: 'dakuten' },
        { symbol: 'ぷ', romaji: 'pu', group: 'dakuten' },
        { symbol: 'ぺ', romaji: 'pe', group: 'dakuten' },
        { symbol: 'ぽ', romaji: 'po', group: 'dakuten' },
        { symbol: 'きゃ', romaji: 'kya', group: 'yoon' },
        { symbol: 'きゅ', romaji: 'kyu', group: 'yoon' },
        { symbol: 'きょ', romaji: 'kyo', group: 'yoon' },
        { symbol: 'ぎゃ', romaji: 'gya', group: 'yoon' },
        { symbol: 'ぎゅ', romaji: 'gyu', group: 'yoon' },
        { symbol: 'ぎょ', romaji: 'gyo', group: 'yoon' },
        { symbol: 'しゃ', romaji: 'sha', group: 'yoon' },
        { symbol: 'しゅ', romaji: 'shu', group: 'yoon' },
        { symbol: 'しょ', romaji: 'sho', group: 'yoon' },
        { symbol: 'じゃ', romaji: 'ja', group: 'yoon' },
        { symbol: 'じゅ', romaji: 'ju', group: 'yoon' },
        { symbol: 'じょ', romaji: 'jo', group: 'yoon' },
        { symbol: 'ちゃ', romaji: 'cha', group: 'yoon' },
        { symbol: 'ちゅ', romaji: 'chu', group: 'yoon' },
        { symbol: 'ちょ', romaji: 'cho', group: 'yoon' },
        { symbol: 'にゃ', romaji: 'nya', group: 'yoon' },
        { symbol: 'にゅ', romaji: 'nyu', group: 'yoon' },
        { symbol: 'にょ', romaji: 'nyo', group: 'yoon' },
        { symbol: 'ひゃ', romaji: 'hya', group: 'yoon' },
        { symbol: 'ひゅ', romaji: 'hyu', group: 'yoon' },
        { symbol: 'ひょ', romaji: 'hyo', group: 'yoon' },
        { symbol: 'びゃ', romaji: 'bya', group: 'yoon' },
        { symbol: 'びゅ', romaji: 'byu', group: 'yoon' },
        { symbol: 'びょ', romaji: 'byo', group: 'yoon' },
        { symbol: 'ぴゃ', romaji: 'pya', group: 'yoon' },
        { symbol: 'ぴゅ', romaji: 'pyu', group: 'yoon' },
        { symbol: 'ぴょ', romaji: 'pyo', group: 'yoon' },
        { symbol: 'みゃ', romaji: 'mya', group: 'yoon' },
        { symbol: 'みゅ', romaji: 'myu', group: 'yoon' },
        { symbol: 'みょ', romaji: 'myo', group: 'yoon' },
        { symbol: 'りゃ', romaji: 'rya', group: 'yoon' },
        { symbol: 'りゅ', romaji: 'ryu', group: 'yoon' },
        { symbol: 'りょ', romaji: 'ryo', group: 'yoon' }
      ];

      const GRID_LAYOUT = [
        ['あ', 'い', 'う', 'え', 'お'],
        ['か', 'き', 'く', 'け', 'こ'],
        ['が', 'ぎ', 'ぐ', 'げ', 'ご'],
        ['さ', 'し', 'す', 'せ', 'そ'],
        ['ざ', 'じ', 'ず', 'ぜ', 'ぞ'],
        ['た', 'ち', 'つ', 'て', 'と'],
        ['だ', 'ぢ', 'づ', 'で', 'ど'],
        ['な', 'に', 'ぬ', 'ね', 'の'],
        ['は', 'ひ', 'ふ', 'へ', 'ほ'],
        ['ば', 'び', 'ぶ', 'べ', 'ぼ'],
        ['ぱ', 'ぴ', 'ぷ', 'ぺ', 'ぽ'],
        ['ま', 'み', 'む', 'め', 'も'],
        ['や', 'ゆ', 'よ', null, null],
        ['ら', 'り', 'る', 'れ', 'ろ'],
        ['わ', 'を', 'ん', null, null],
        ['きゃ', 'きゅ', 'きょ', null, null],
        ['ぎゃ', 'ぎゅ', 'ぎょ', null, null],
        ['しゃ', 'しゅ', 'しょ', null, null],
        ['じゃ', 'じゅ', 'じょ', null, null],
        ['ちゃ', 'ちゅ', 'ちょ', null, null],
        ['にゃ', 'にゅ', 'にょ', null, null],
        ['ひゃ', 'ひゅ', 'ひょ', null, null],
        ['びゃ', 'びゅ', 'びょ', null, null],
        ['ぴゃ', 'ぴゅ', 'ぴょ', null, null],
        ['みゃ', 'みゅ', 'みょ', null, null],
        ['りゃ', 'りゅ', 'りょ', null, null]
      ];

      const BASE_SYMBOLS = new Set(HIRAGANA_DATA.filter(item => item.group === 'base').map(item => item.symbol));
      const symbolToEntry = new Map(HIRAGANA_DATA.map(item => [item.symbol, item]));

      const rowsWrap = document.getElementById('rows');
      const answerEl = document.getElementById('answer');
      const regenBtn = document.getElementById('regenBtn');
      const alphabetPanel = document.getElementById('alphabetPanel');
      const openAlphabet = document.getElementById('openAlphabet');
      const closeAlphabet = document.getElementById('closeAlphabet');
      const applyAlphabet = document.getElementById('applyAlphabet');
      const selectAllBtn = document.getElementById('selectAllBtn');
      const deselectAllBtn = document.getElementById('deselectAllBtn');
      const resetAlphabet = document.getElementById('resetAlphabet');
      const hiraganaGrid = document.getElementById('hiraganaGrid');
      const panel = document.getElementById('panel');
      const openSettings = document.getElementById('openSettings');
      const closeSettings = document.getElementById('closeSettings');
      const backdrop = document.getElementById('backdrop');
      const rowsCountInput = document.getElementById('rowsCount');
      const lenPerRowInput = document.getElementById('lenPerRow');
      const kanaSizeInput = document.getElementById('kanaSize');
      const applySettings = document.getElementById('applySettings');
      const resetSettings = document.getElementById('resetSettings');

      const clamp = (value, min, max) => {
        const number = parseInt(value, 10);
        if (Number.isNaN(number)) {
          return min;
        }
        return Math.max(min, Math.min(max, number));
      };

      let rowsCount = clamp(rowsCountInput.value, 1, 10);
      let lenPerRow = clamp(lenPerRowInput.value, 1, 20);
      let kanaSize = clamp(kanaSizeInput.value, 24, 120);

      let selectedKanas = new Set(BASE_SYMBOLS);
      let currentSeq = [];
      let breakpoints = [];
      let currentIdx = 0;

      function setKanaSize(px) {
        document.documentElement.style.setProperty('--kanaSize', px + 'px');
      }

      function getActiveKanaList() {
        const list = [];
        selectedKanas.forEach((symbol) => {
          const entry = symbolToEntry.get(symbol);
          if (entry) {
            list.push([entry.symbol, entry.romaji]);
          }
        });
        return list;
      }

      function renderAlphabetGrid() {
        hiraganaGrid.innerHTML = '';
        GRID_LAYOUT.forEach((row) => {
          row.forEach((symbol) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'grid-item';
            if (!symbol) {
              button.classList.add('empty');
              hiraganaGrid.appendChild(button);
              return;
            }
            const entry = symbolToEntry.get(symbol);
            if (!entry) {
              button.classList.add('empty');
              hiraganaGrid.appendChild(button);
              return;
            }
            button.dataset.kana = entry.symbol;
            button.innerHTML = '<span class="kana">' + entry.symbol + '</span><span class="romaji">' + entry.romaji + '</span>';
            if (selectedKanas.has(entry.symbol)) {
              button.classList.add('selected');
            }
            button.addEventListener('click', () => {
              if (selectedKanas.has(entry.symbol)) {
                selectedKanas.delete(entry.symbol);
              } else {
                selectedKanas.add(entry.symbol);
              }
              button.classList.toggle('selected', selectedKanas.has(entry.symbol));
            });
            hiraganaGrid.appendChild(button);
          });
        });
      }

      function ensureSelection() {
        if (!selectedKanas.size) {
          selectedKanas = new Set(BASE_SYMBOLS);
        }
      }

      function openAlphabetPanel() {
        alphabetPanel.classList.add('open');
        alphabetPanel.setAttribute('aria-hidden', 'false');
        backdrop.classList.add('show');
        backdrop.setAttribute('aria-hidden', 'false');
      }

      function closeAlphabetPanel() {
        alphabetPanel.classList.remove('open');
        alphabetPanel.setAttribute('aria-hidden', 'true');
        if (!panel.classList.contains('open')) {
          backdrop.classList.remove('show');
          backdrop.setAttribute('aria-hidden', 'true');
        }
      }

      function openSettingsPanel() {
        panel.classList.add('open');
        panel.setAttribute('aria-hidden', 'false');
        backdrop.classList.add('show');
        backdrop.setAttribute('aria-hidden', 'false');
      }

      function closeSettingsPanel() {
        panel.classList.remove('open');
        panel.setAttribute('aria-hidden', 'true');
        if (!alphabetPanel.classList.contains('open')) {
          backdrop.classList.remove('show');
          backdrop.setAttribute('aria-hidden', 'true');
        }
      }

      function newSet() {
        const activeKanas = getActiveKanaList();
        if (!activeKanas.length) {
          rowsWrap.innerHTML = '<p class="info-message">Выберите хотя бы один слог в фильтре.</p>';
          currentSeq = [];
          breakpoints = [];
          currentIdx = 0;
          return;
        }

        currentSeq = [];
        breakpoints = [];

        for (let r = 0; r < rowsCount; r += 1) {
          const pool = activeKanas.slice();
          const row = [];
          while (row.length < lenPerRow && pool.length > 0) {
            const index = Math.floor(Math.random() * pool.length);
            row.push(pool[index]);
            pool.splice(index, 1);
          }
          if (row.length) {
            Array.prototype.push.apply(currentSeq, row);
            breakpoints.push(currentSeq.length - 1);
          }
        }

        currentIdx = 0;
        renderRows();
        setCurrentVisual();
        answerEl.value = '';
        answerEl.focus();
      }

      function renderRows() {
        rowsWrap.innerHTML = '';
        let start = 0;
        breakpoints.forEach((end) => {
          const rowDiv = document.createElement('div');
          rowDiv.className = 'row';
          for (let i = start; i <= end; i += 1) {
            const span = document.createElement('span');
            span.className = 'kana';
            span.dataset.idx = String(i);
            span.textContent = currentSeq[i][0];
            rowDiv.appendChild(span);
          }
          rowsWrap.appendChild(rowDiv);
          start = end + 1;
        });
      }

      function setCurrentVisual() {
        const spans = rowsWrap.querySelectorAll('.kana');
        spans.forEach((span) => span.classList.remove('current'));
        if (spans[currentIdx]) {
          spans[currentIdx].classList.add('current');
        }
      }

      const CYRILLIC_VOWELS = new Set(['а', 'е', 'ё', 'и', 'о', 'у', 'ы', 'э', 'ю', 'я']);
      const ROMAJI_ALIASES = { si: 'shi', ti: 'chi', tu: 'tsu', hu: 'fu', zi: 'ji', di: 'ji', du: 'zu', syu: 'shu', sya: 'sha', syo: 'sho', tyu: 'chu', tya: 'cha', tyo: 'cho' };
      const RU_TO_ROMAJI = {
        'а': 'a', 'б': 'b', 'в': 'v', 'г': 'g', 'д': 'd', 'е': 'e', 'ё': 'yo', 'ж': 'zh',
        'з': 'z', 'и': 'i', 'й': 'y', 'к': 'k', 'л': 'l', 'м': 'm', 'н': 'n', 'о': 'o',
        'п': 'p', 'р': 'r', 'с': 's', 'т': 't', 'у': 'u', 'ф': 'f', 'х': 'h', 'ц': 'ts',
        'ч': 'ch', 'ш': 'sh', 'щ': 'shch', 'ъ': '', 'ы': 'y', 'ь': '', 'э': 'e', 'ю': 'yu', 'я': 'ya'
      };

      const hasCyrillic = (value) => /[Ѐ-ӿ]/.test(value);

      function normalizeToken(raw) {
        const value = (raw || '').trim().toLowerCase();
        if (!value) {
          return '';
        }
        let normalized = value;
        if (hasCyrillic(value)) {
          normalized = '';
          for (const ch of value) {
            normalized += RU_TO_ROMAJI.hasOwnProperty(ch) ? RU_TO_ROMAJI[ch] : ch;
          }
        }
        normalized = normalized.split('').filter((ch) => (ch >= 'a' && ch <= 'z') || (ch >= '0' && ch <= '9') || ch === '-').join('');
        if (ROMAJI_ALIASES.hasOwnProperty(normalized)) {
          normalized = ROMAJI_ALIASES[normalized];
        }
        return normalized;
      }

      function isVowelLat(ch) {
        return ch === 'a' || ch === 'e' || ch === 'i' || ch === 'o' || ch === 'u';
      }

      function isVowelRu(ch) {
        return CYRILLIC_VOWELS.has(ch);
      }

      function okMatch(expected, got) {
        if (got === expected) {
          return true;
        }
        if (expected === 'wo' && (got === 'wo' || got === 'o')) {
          return true;
        }
        if (expected === 'n' && (got === 'n' || got === 'm')) {
          return true;
        }
        return false;
      }

      function submitCurrent() {
        if (currentIdx >= currentSeq.length) {
          return;
        }
        const spans = rowsWrap.querySelectorAll('.kana');
        const tokenRaw = answerEl.value;
        const normalized = normalizeToken(tokenRaw);
        if (!normalized) {
          return;
        }
        const expected = currentSeq[currentIdx][1];
        const span = spans[currentIdx];
        if (okMatch(expected, normalized)) {
          span.classList.remove('current');
          span.classList.add('done');
          answerEl.value = '';
          currentIdx += 1;
          if (currentIdx >= currentSeq.length) {
            newSet();
            return;
          }
          setCurrentVisual();
        } else {
          span.classList.remove('blink');
          void span.offsetWidth;
          span.classList.add('blink');
          answerEl.select();
        }
      }

      answerEl.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ' || event.key === 'Spacebar') {
          event.preventDefault();
          submitCurrent();
        }
      });

      answerEl.addEventListener('input', () => {
        if (currentIdx >= currentSeq.length) {
          return;
        }
        const rawValue = (answerEl.value || '').toLowerCase();
        if (!rawValue) {
          return;
        }
        const expected = currentSeq[currentIdx][1];
        const hasC = hasCyrillic(rawValue);
        let foundVowel = false;
        if (hasC) {
          for (const ch of rawValue) {
            if (isVowelRu(ch)) {
              foundVowel = true;
              break;
            }
          }
        } else {
          for (const ch of rawValue) {
            if (isVowelLat(ch)) {
              foundVowel = true;
              break;
            }
          }
        }
        const normalized = normalizeToken(rawValue);
        if (normalized === expected) {
          submitCurrent();
          return;
        }
        if (foundVowel || normalized.length >= expected.length) {
          submitCurrent();
        }
      });

      openAlphabet.addEventListener('click', () => {
        renderAlphabetGrid();
        openAlphabetPanel();
      });
      closeAlphabet.addEventListener('click', closeAlphabetPanel);
      applyAlphabet.addEventListener('click', () => {
        ensureSelection();
        newSet();
        closeAlphabetPanel();
      });
      selectAllBtn.addEventListener('click', () => {
        selectedKanas = new Set(HIRAGANA_DATA.map((item) => item.symbol));
        renderAlphabetGrid();
      });
      deselectAllBtn.addEventListener('click', () => {
        selectedKanas.clear();
        renderAlphabetGrid();
      });
      resetAlphabet.addEventListener('click', () => {
        selectedKanas = new Set(BASE_SYMBOLS);
        renderAlphabetGrid();
      });

      openSettings.addEventListener('click', openSettingsPanel);
      closeSettings.addEventListener('click', closeSettingsPanel);
      applySettings.addEventListener('click', () => {
        rowsCount = clamp(rowsCountInput.value, 1, 10);
        lenPerRow = clamp(lenPerRowInput.value, 1, 20);
        kanaSize = clamp(kanaSizeInput.value, 24, 120);
        setKanaSize(kanaSize);
        newSet();
        closeSettingsPanel();
      });
      resetSettings.addEventListener('click', () => {
        rowsCountInput.value = 1;
        lenPerRowInput.value = 7;
        kanaSizeInput.value = 50;
        rowsCount = 1;
        lenPerRow = 7;
        kanaSize = 50;
        setKanaSize(kanaSize);
        newSet();
      });
      regenBtn.addEventListener('click', newSet);

      backdrop.addEventListener('click', () => {
        closeAlphabetPanel();
        closeSettingsPanel();
      });

      setKanaSize(kanaSize);
      renderAlphabetGrid();
      newSet();
      answerEl.focus();
    })();
  </script>
</body>
</html>
