<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>ÐŸÑ€Ð°ÐºÑ‚Ð¸ÐºÐ° Ñ…Ð¸Ñ€Ð°Ð³Ð°Ð½Ñ‹ â€” ÑÐ»Ð¾Ð³Ð¾Ð²Ñ‹Ðµ Ñ‚Ñ€ÐµÐ½Ð°Ð¶Ñ‘Ñ€Ñ‹</title>
  <link rel="stylesheet" href="./css/hiragana.css">
</head>
<body>
  <a class="home-button" href="index.html">ÐÐ°Ð·Ð°Ð´</a>
  <div class="wrap">
    <div class="card">
      <div id="rows" class="rows" aria-live="polite"></div>
      <div class="controls">
        <input id="answer" type="text" autocomplete="off" spellcheck="false" placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ€Ð¾Ð¼Ð°Ð´Ð·Ð¸" />
      </div>
    </div>
  </div>

  <button id="openAlphabet" class="fab alphabet-btn" title="Ð’Ñ‹Ð±Ð¾Ñ€ ÑÐ»Ð¾Ð³Ð¾Ð²">ã‚+</button>
  <button id="openSettings" class="fab settings-btn" title="ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸">âš™</button>
  <button id="regenBtn" class="fab regen-btn" title="ÐÐ¾Ð²Ñ‹Ð¹ Ð½Ð°Ð±Ð¾Ñ€">â†»</button>

  <aside id="alphabetPanel" class="panel alphabet-panel" aria-hidden="true">
    <header>
      <strong>Ð’Ñ‹Ð±Ð¾Ñ€ ÑÐ»Ð¾Ð³Ð¾Ð² Ð´Ð»Ñ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ¸</strong>
      <button id="closeAlphabet" class="btn ghost" type="button">Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ</button>
    </header>
    <div class="content">
      <div class="select-toolbar">
        <button id="selectAllBtn" class="btn ghost" type="button">Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð²ÑÐµ</button>
        <button id="deselectAllBtn" class="btn ghost" type="button">Ð¡Ð½ÑÑ‚ÑŒ Ð²ÑÐµ</button>
        <button id="resetAlphabet" class="btn ghost" type="button">ÐŸÐ¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ</button>
      </div>
      <div id="hiraganaGrid" class="kana-grid"></div>
    </div>
    <div class="actions">
      <button id="applyAlphabet" class="btn" type="button">ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ðµ</button>
    </div>
  </aside>

  <aside id="panel" class="panel" aria-hidden="true">
    <header>
      <strong>ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ¸</strong>
      <button id="closeSettings" class="btn ghost" type="button">Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ</button>
    </header>
    <div class="content">
      <div class="field">
        <label for="rowsCount">ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÑ‚Ñ€Ð¾Ðº</label>
        <input id="rowsCount" class="num" type="number" min="1" max="10" value="1">
      </div>
      <div class="field">
        <label for="lenPerRow">Ð¡Ð¸Ð¼Ð²Ð¾Ð»Ð¾Ð² Ð² ÑÑ‚Ñ€Ð¾ÐºÐµ</label>
        <input id="lenPerRow" class="num" type="number" min="1" max="20" value="7">
      </div>
      <div class="field">
        <label for="kanaSize">Ð Ð°Ð·Ð¼ÐµÑ€ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²</label>
        <input id="kanaSize" type="range" min="24" max="120" value="50">
      </div>
    </div>
    <div class="actions">
      <button id="applySettings" class="btn" type="button">ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ</button>
      <button id="resetSettings" class="btn ghost" type="button">Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ</button>
    </div>
  </aside>

  <div id="backdrop" class="backdrop" aria-hidden="true"></div>

  <script>
    (function () {
      const HIRAGANA_DATA = [
        { symbol: 'ã‚', romaji: 'a', group: 'base' },
        { symbol: 'ã„', romaji: 'i', group: 'base' },
        { symbol: 'ã†', romaji: 'u', group: 'base' },
        { symbol: 'ãˆ', romaji: 'e', group: 'base' },
        { symbol: 'ãŠ', romaji: 'o', group: 'base' },
        { symbol: 'ã‹', romaji: 'ka', group: 'base' },
        { symbol: 'ã', romaji: 'ki', group: 'base' },
        { symbol: 'ã', romaji: 'ku', group: 'base' },
        { symbol: 'ã‘', romaji: 'ke', group: 'base' },
        { symbol: 'ã“', romaji: 'ko', group: 'base' },
        { symbol: 'ã•', romaji: 'sa', group: 'base' },
        { symbol: 'ã—', romaji: 'shi', group: 'base' },
        { symbol: 'ã™', romaji: 'su', group: 'base' },
        { symbol: 'ã›', romaji: 'se', group: 'base' },
        { symbol: 'ã', romaji: 'so', group: 'base' },
        { symbol: 'ãŸ', romaji: 'ta', group: 'base' },
        { symbol: 'ã¡', romaji: 'chi', group: 'base' },
        { symbol: 'ã¤', romaji: 'tsu', group: 'base' },
        { symbol: 'ã¦', romaji: 'te', group: 'base' },
        { symbol: 'ã¨', romaji: 'to', group: 'base' },
        { symbol: 'ãª', romaji: 'na', group: 'base' },
        { symbol: 'ã«', romaji: 'ni', group: 'base' },
        { symbol: 'ã¬', romaji: 'nu', group: 'base' },
        { symbol: 'ã­', romaji: 'ne', group: 'base' },
        { symbol: 'ã®', romaji: 'no', group: 'base' },
        { symbol: 'ã¯', romaji: 'ha', group: 'base' },
        { symbol: 'ã²', romaji: 'hi', group: 'base' },
        { symbol: 'ãµ', romaji: 'fu', group: 'base' },
        { symbol: 'ã¸', romaji: 'he', group: 'base' },
        { symbol: 'ã»', romaji: 'ho', group: 'base' },
        { symbol: 'ã¾', romaji: 'ma', group: 'base' },
        { symbol: 'ã¿', romaji: 'mi', group: 'base' },
        { symbol: 'ã‚€', romaji: 'mu', group: 'base' },
        { symbol: 'ã‚', romaji: 'me', group: 'base' },
        { symbol: 'ã‚‚', romaji: 'mo', group: 'base' },
        { symbol: 'ã‚„', romaji: 'ya', group: 'base' },
        { symbol: 'ã‚†', romaji: 'yu', group: 'base' },
        { symbol: 'ã‚ˆ', romaji: 'yo', group: 'base' },
        { symbol: 'ã‚‰', romaji: 'ra', group: 'base' },
        { symbol: 'ã‚Š', romaji: 'ri', group: 'base' },
        { symbol: 'ã‚‹', romaji: 'ru', group: 'base' },
        { symbol: 'ã‚Œ', romaji: 're', group: 'base' },
        { symbol: 'ã‚', romaji: 'ro', group: 'base' },
        { symbol: 'ã‚', romaji: 'wa', group: 'base' },
        { symbol: 'ã‚’', romaji: 'wo', group: 'base' },
        { symbol: 'ã‚“', romaji: 'n', group: 'base' },
        { symbol: 'ãŒ', romaji: 'ga', group: 'dakuten' },
        { symbol: 'ãŽ', romaji: 'gi', group: 'dakuten' },
        { symbol: 'ã', romaji: 'gu', group: 'dakuten' },
        { symbol: 'ã’', romaji: 'ge', group: 'dakuten' },
        { symbol: 'ã”', romaji: 'go', group: 'dakuten' },
        { symbol: 'ã–', romaji: 'za', group: 'dakuten' },
        { symbol: 'ã˜', romaji: 'ji', group: 'dakuten' },
        { symbol: 'ãš', romaji: 'zu', group: 'dakuten' },
        { symbol: 'ãœ', romaji: 'ze', group: 'dakuten' },
        { symbol: 'ãž', romaji: 'zo', group: 'dakuten' },
        { symbol: 'ã ', romaji: 'da', group: 'dakuten' },
        { symbol: 'ã¢', romaji: 'ji', group: 'dakuten' },
        { symbol: 'ã¥', romaji: 'zu', group: 'dakuten' },
        { symbol: 'ã§', romaji: 'de', group: 'dakuten' },
        { symbol: 'ã©', romaji: 'do', group: 'dakuten' },
        { symbol: 'ã°', romaji: 'ba', group: 'dakuten' },
        { symbol: 'ã³', romaji: 'bi', group: 'dakuten' },
        { symbol: 'ã¶', romaji: 'bu', group: 'dakuten' },
        { symbol: 'ã¹', romaji: 'be', group: 'dakuten' },
        { symbol: 'ã¼', romaji: 'bo', group: 'dakuten' },
        { symbol: 'ã±', romaji: 'pa', group: 'dakuten' },
        { symbol: 'ã´', romaji: 'pi', group: 'dakuten' },
        { symbol: 'ã·', romaji: 'pu', group: 'dakuten' },
        { symbol: 'ãº', romaji: 'pe', group: 'dakuten' },
        { symbol: 'ã½', romaji: 'po', group: 'dakuten' },
        { symbol: 'ãã‚ƒ', romaji: 'kya', group: 'yoon' },
        { symbol: 'ãã‚…', romaji: 'kyu', group: 'yoon' },
        { symbol: 'ãã‚‡', romaji: 'kyo', group: 'yoon' },
        { symbol: 'ãŽã‚ƒ', romaji: 'gya', group: 'yoon' },
        { symbol: 'ãŽã‚…', romaji: 'gyu', group: 'yoon' },
        { symbol: 'ãŽã‚‡', romaji: 'gyo', group: 'yoon' },
        { symbol: 'ã—ã‚ƒ', romaji: 'sha', group: 'yoon' },
        { symbol: 'ã—ã‚…', romaji: 'shu', group: 'yoon' },
        { symbol: 'ã—ã‚‡', romaji: 'sho', group: 'yoon' },
        { symbol: 'ã˜ã‚ƒ', romaji: 'ja', group: 'yoon' },
        { symbol: 'ã˜ã‚…', romaji: 'ju', group: 'yoon' },
        { symbol: 'ã˜ã‚‡', romaji: 'jo', group: 'yoon' },
        { symbol: 'ã¡ã‚ƒ', romaji: 'cha', group: 'yoon' },
        { symbol: 'ã¡ã‚…', romaji: 'chu', group: 'yoon' },
        { symbol: 'ã¡ã‚‡', romaji: 'cho', group: 'yoon' },
        { symbol: 'ã«ã‚ƒ', romaji: 'nya', group: 'yoon' },
        { symbol: 'ã«ã‚…', romaji: 'nyu', group: 'yoon' },
        { symbol: 'ã«ã‚‡', romaji: 'nyo', group: 'yoon' },
        { symbol: 'ã²ã‚ƒ', romaji: 'hya', group: 'yoon' },
        { symbol: 'ã²ã‚…', romaji: 'hyu', group: 'yoon' },
        { symbol: 'ã²ã‚‡', romaji: 'hyo', group: 'yoon' },
        { symbol: 'ã³ã‚ƒ', romaji: 'bya', group: 'yoon' },
        { symbol: 'ã³ã‚…', romaji: 'byu', group: 'yoon' },
        { symbol: 'ã³ã‚‡', romaji: 'byo', group: 'yoon' },
        { symbol: 'ã´ã‚ƒ', romaji: 'pya', group: 'yoon' },
        { symbol: 'ã´ã‚…', romaji: 'pyu', group: 'yoon' },
        { symbol: 'ã´ã‚‡', romaji: 'pyo', group: 'yoon' },
        { symbol: 'ã¿ã‚ƒ', romaji: 'mya', group: 'yoon' },
        { symbol: 'ã¿ã‚…', romaji: 'myu', group: 'yoon' },
        { symbol: 'ã¿ã‚‡', romaji: 'myo', group: 'yoon' },
        { symbol: 'ã‚Šã‚ƒ', romaji: 'rya', group: 'yoon' },
        { symbol: 'ã‚Šã‚…', romaji: 'ryu', group: 'yoon' },
        { symbol: 'ã‚Šã‚‡', romaji: 'ryo', group: 'yoon' }
      ];

      const GRID_LAYOUT = [
        ['ã‚', 'ã„', 'ã†', 'ãˆ', 'ãŠ'],
        ['ã‹', 'ã', 'ã', 'ã‘', 'ã“'],
        ['ãŒ', 'ãŽ', 'ã', 'ã’', 'ã”'],
        ['ã•', 'ã—', 'ã™', 'ã›', 'ã'],
        ['ã–', 'ã˜', 'ãš', 'ãœ', 'ãž'],
        ['ãŸ', 'ã¡', 'ã¤', 'ã¦', 'ã¨'],
        ['ã ', 'ã¢', 'ã¥', 'ã§', 'ã©'],
        ['ãª', 'ã«', 'ã¬', 'ã­', 'ã®'],
        ['ã¯', 'ã²', 'ãµ', 'ã¸', 'ã»'],
        ['ã°', 'ã³', 'ã¶', 'ã¹', 'ã¼'],
        ['ã±', 'ã´', 'ã·', 'ãº', 'ã½'],
        ['ã¾', 'ã¿', 'ã‚€', 'ã‚', 'ã‚‚'],
        ['ã‚„', 'ã‚†', 'ã‚ˆ', null, null],
        ['ã‚‰', 'ã‚Š', 'ã‚‹', 'ã‚Œ', 'ã‚'],
        ['ã‚', 'ã‚’', 'ã‚“', null, null],
        ['ãã‚ƒ', 'ãã‚…', 'ãã‚‡', null, null],
        ['ãŽã‚ƒ', 'ãŽã‚…', 'ãŽã‚‡', null, null],
        ['ã—ã‚ƒ', 'ã—ã‚…', 'ã—ã‚‡', null, null],
        ['ã˜ã‚ƒ', 'ã˜ã‚…', 'ã˜ã‚‡', null, null],
        ['ã¡ã‚ƒ', 'ã¡ã‚…', 'ã¡ã‚‡', null, null],
        ['ã«ã‚ƒ', 'ã«ã‚…', 'ã«ã‚‡', null, null],
        ['ã²ã‚ƒ', 'ã²ã‚…', 'ã²ã‚‡', null, null],
        ['ã³ã‚ƒ', 'ã³ã‚…', 'ã³ã‚‡', null, null],
        ['ã´ã‚ƒ', 'ã´ã‚…', 'ã´ã‚‡', null, null],
        ['ã¿ã‚ƒ', 'ã¿ã‚…', 'ã¿ã‚‡', null, null],
        ['ã‚Šã‚ƒ', 'ã‚Šã‚…', 'ã‚Šã‚‡', null, null]
      ];

      const BASE_SYMBOLS = new Set(HIRAGANA_DATA.filter(item => item.group === 'base').map(item => item.symbol));
      const symbolToEntry = new Map(HIRAGANA_DATA.map(item => [item.symbol, item]));

      const rowsWrap = document.getElementById('rows');
      const answerEl = document.getElementById('answer');
      const regenBtn = document.getElementById('regenBtn');
      const alphabetPanel = document.getElementById('alphabetPanel');
      const openAlphabet = document.getElementById('openAlphabet');
      const closeAlphabet = document.getElementById('closeAlphabet');
      const applyAlphabet = document.getElementById('applyAlphabet');
      const selectAllBtn = document.getElementById('selectAllBtn');
      const deselectAllBtn = document.getElementById('deselectAllBtn');
      const resetAlphabet = document.getElementById('resetAlphabet');
      const hiraganaGrid = document.getElementById('hiraganaGrid');
      const panel = document.getElementById('panel');
      const openSettings = document.getElementById('openSettings');
      const closeSettings = document.getElementById('closeSettings');
      const backdrop = document.getElementById('backdrop');
      const rowsCountInput = document.getElementById('rowsCount');
      const lenPerRowInput = document.getElementById('lenPerRow');
      const kanaSizeInput = document.getElementById('kanaSize');
      const applySettings = document.getElementById('applySettings');
      const resetSettings = document.getElementById('resetSettings');

      const clamp = (value, min, max) => {
        const number = parseInt(value, 10);
        if (Number.isNaN(number)) {
          return min;
        }
        return Math.max(min, Math.min(max, number));
      };

      let rowsCount = clamp(rowsCountInput.value, 1, 10);
      let lenPerRow = clamp(lenPerRowInput.value, 1, 20);
      let kanaSize = clamp(kanaSizeInput.value, 24, 120);

      let selectedKanas = new Set(BASE_SYMBOLS);
      let currentSeq = [];
      let breakpoints = [];
      let currentIdx = 0;

      function setKanaSize(px) {
        document.documentElement.style.setProperty('--kanaSize', px + 'px');
      }

      function getActiveKanaList() {
        const list = [];
        selectedKanas.forEach((symbol) => {
          const entry = symbolToEntry.get(symbol);
          if (entry) {
            list.push([entry.symbol, entry.romaji]);
          }
        });
        return list;
      }

      function renderAlphabetGrid() {
        hiraganaGrid.innerHTML = '';
        GRID_LAYOUT.forEach((row) => {
          row.forEach((symbol) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'grid-item';
            if (!symbol) {
              button.classList.add('empty');
              hiraganaGrid.appendChild(button);
              return;
            }
            const entry = symbolToEntry.get(symbol);
            if (!entry) {
              button.classList.add('empty');
              hiraganaGrid.appendChild(button);
              return;
            }
            button.dataset.kana = entry.symbol;
            button.innerHTML = '<span class="kana">' + entry.symbol + '</span><span class="romaji">' + entry.romaji + '</span>';
            if (selectedKanas.has(entry.symbol)) {
              button.classList.add('selected');
            }
            button.addEventListener('click', () => {
              if (selectedKanas.has(entry.symbol)) {
                selectedKanas.delete(entry.symbol);
              } else {
                selectedKanas.add(entry.symbol);
              }
              button.classList.toggle('selected', selectedKanas.has(entry.symbol));
            });
            hiraganaGrid.appendChild(button);
          });
        });
      }

      function ensureSelection() {
        if (!selectedKanas.size) {
          selectedKanas = new Set(BASE_SYMBOLS);
        }
      }

      function openAlphabetPanel() {
        alphabetPanel.classList.add('open');
        alphabetPanel.setAttribute('aria-hidden', 'false');
        backdrop.classList.add('show');
        backdrop.setAttribute('aria-hidden', 'false');
      }

      function closeAlphabetPanel() {
        alphabetPanel.classList.remove('open');
        alphabetPanel.setAttribute('aria-hidden', 'true');
        if (!panel.classList.contains('open')) {
          backdrop.classList.remove('show');
          backdrop.setAttribute('aria-hidden', 'true');
        }
      }

      function openSettingsPanel() {
        panel.classList.add('open');
        panel.setAttribute('aria-hidden', 'false');
        backdrop.classList.add('show');
        backdrop.setAttribute('aria-hidden', 'false');
      }

      function closeSettingsPanel() {
        panel.classList.remove('open');
        panel.setAttribute('aria-hidden', 'true');
        if (!alphabetPanel.classList.contains('open')) {
          backdrop.classList.remove('show');
          backdrop.setAttribute('aria-hidden', 'true');
        }
      }

      function newSet() {
        const activeKanas = getActiveKanaList();
        if (!activeKanas.length) {
          rowsWrap.innerHTML = '<p class="info-message">Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ…Ð¾Ñ‚Ñ Ð±Ñ‹ Ð¾Ð´Ð¸Ð½ ÑÐ»Ð¾Ð³ Ð² Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ðµ.</p>';
          currentSeq = [];
          breakpoints = [];
          currentIdx = 0;
          return;
        }

        currentSeq = [];
        breakpoints = [];

        for (let r = 0; r < rowsCount; r += 1) {
          const pool = activeKanas.slice();
          const row = [];
          while (row.length < lenPerRow && pool.length > 0) {
            const index = Math.floor(Math.random() * pool.length);
            row.push(pool[index]);
            pool.splice(index, 1);
          }
          if (row.length) {
            Array.prototype.push.apply(currentSeq, row);
            breakpoints.push(currentSeq.length - 1);
          }
        }

        currentIdx = 0;
        renderRows();
        setCurrentVisual();
        answerEl.value = '';
        answerEl.focus();
      }

      function renderRows() {
        rowsWrap.innerHTML = '';
        let start = 0;
        breakpoints.forEach((end) => {
          const rowDiv = document.createElement('div');
          rowDiv.className = 'row';
          for (let i = start; i <= end; i += 1) {
            const span = document.createElement('span');
            span.className = 'kana';
            span.dataset.idx = String(i);
            span.textContent = currentSeq[i][0];
            rowDiv.appendChild(span);
          }
          rowsWrap.appendChild(rowDiv);
          start = end + 1;
        });
      }

      function setCurrentVisual() {
        const spans = rowsWrap.querySelectorAll('.kana');
        spans.forEach((span) => span.classList.remove('current'));
        if (spans[currentIdx]) {
          spans[currentIdx].classList.add('current');
        }
      }

      const CYRILLIC_VOWELS = new Set(['Ð°', 'Ðµ', 'Ñ‘', 'Ð¸', 'Ð¾', 'Ñƒ', 'Ñ‹', 'Ñ', 'ÑŽ', 'Ñ']);
      const ROMAJI_ALIASES = { si: 'shi', ti: 'chi', tu: 'tsu', hu: 'fu', zi: 'ji', di: 'ji', du: 'zu', syu: 'shu', sya: 'sha', syo: 'sho', tyu: 'chu', tya: 'cha', tyo: 'cho' };
      const RU_TO_ROMAJI = {
        'Ð°': 'a', 'Ð±': 'b', 'Ð²': 'v', 'Ð³': 'g', 'Ð´': 'd', 'Ðµ': 'e', 'Ñ‘': 'yo', 'Ð¶': 'zh',
        'Ð·': 'z', 'Ð¸': 'i', 'Ð¹': 'y', 'Ðº': 'k', 'Ð»': 'l', 'Ð¼': 'm', 'Ð½': 'n', 'Ð¾': 'o',
        'Ð¿': 'p', 'Ñ€': 'r', 'Ñ': 's', 'Ñ‚': 't', 'Ñƒ': 'u', 'Ñ„': 'f', 'Ñ…': 'h', 'Ñ†': 'ts',
        'Ñ‡': 'ch', 'Ñˆ': 'sh', 'Ñ‰': 'shch', 'ÑŠ': '', 'Ñ‹': 'y', 'ÑŒ': '', 'Ñ': 'e', 'ÑŽ': 'yu', 'Ñ': 'ya'
      };

      const hasCyrillic = (value) => /[Ð€-Ó¿]/.test(value);

      function normalizeToken(raw) {
        const value = (raw || '').trim().toLowerCase();
        if (!value) {
          return '';
        }
        let normalized = value;
        if (hasCyrillic(value)) {
          normalized = '';
          for (const ch of value) {
            normalized += RU_TO_ROMAJI.hasOwnProperty(ch) ? RU_TO_ROMAJI[ch] : ch;
          }
        }
        normalized = normalized.split('').filter((ch) => (ch >= 'a' && ch <= 'z') || (ch >= '0' && ch <= '9') || ch === '-').join('');
        if (ROMAJI_ALIASES.hasOwnProperty(normalized)) {
          normalized = ROMAJI_ALIASES[normalized];
        }
        return normalized;
      }

      function isVowelLat(ch) {
        return ch === 'a' || ch === 'e' || ch === 'i' || ch === 'o' || ch === 'u';
      }

      function isVowelRu(ch) {
        return CYRILLIC_VOWELS.has(ch);
      }

      function okMatch(expected, got) {
        if (got === expected) {
          return true;
        }
        if (expected === 'wo' && (got === 'wo' || got === 'o')) {
          return true;
        }
        if (expected === 'n' && (got === 'n' || got === 'm')) {
          return true;
        }
        return false;
      }

      function submitCurrent() {
        if (currentIdx >= currentSeq.length) {
          return;
        }
        const spans = rowsWrap.querySelectorAll('.kana');
        const tokenRaw = answerEl.value;
        const normalized = normalizeToken(tokenRaw);
        if (!normalized) {
          return;
        }
        const expected = currentSeq[currentIdx][1];
        const span = spans[currentIdx];
        if (okMatch(expected, normalized)) {
          span.classList.remove('current');
          span.classList.add('done');
          answerEl.value = '';
          currentIdx += 1;
          if (currentIdx >= currentSeq.length) {
            newSet();
            return;
          }
          setCurrentVisual();
        } else {
          span.classList.remove('blink');
          void span.offsetWidth;
          span.classList.add('blink');
          answerEl.select();
        }
      }

      answerEl.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ' || event.key === 'Spacebar') {
          event.preventDefault();
          submitCurrent();
        }
      });

      answerEl.addEventListener('input', () => {
        if (currentIdx >= currentSeq.length) {
          return;
        }
        const rawValue = (answerEl.value || '').toLowerCase();
        if (!rawValue) {
          return;
        }
        const expected = currentSeq[currentIdx][1];
        const hasC = hasCyrillic(rawValue);
        let foundVowel = false;
        if (hasC) {
          for (const ch of rawValue) {
            if (isVowelRu(ch)) {
              foundVowel = true;
              break;
            }
          }
        } else {
          for (const ch of rawValue) {
            if (isVowelLat(ch)) {
              foundVowel = true;
              break;
            }
          }
        }
        const normalized = normalizeToken(rawValue);
        if (normalized === expected) {
          submitCurrent();
          return;
        }
        if (foundVowel || normalized.length >= expected.length) {
          submitCurrent();
        }
      });

      openAlphabet.addEventListener('click', () => {
        renderAlphabetGrid();
        openAlphabetPanel();
      });
      closeAlphabet.addEventListener('click', closeAlphabetPanel);
      applyAlphabet.addEventListener('click', () => {
        ensureSelection();
        newSet();
        closeAlphabetPanel();
      });
      selectAllBtn.addEventListener('click', () => {
        selectedKanas = new Set(HIRAGANA_DATA.map((item) => item.symbol));
        renderAlphabetGrid();
      });
      deselectAllBtn.addEventListener('click', () => {
        selectedKanas.clear();
        renderAlphabetGrid();
      });
      resetAlphabet.addEventListener('click', () => {
        selectedKanas = new Set(BASE_SYMBOLS);
        renderAlphabetGrid();
      });

      openSettings.addEventListener('click', openSettingsPanel);
      closeSettings.addEventListener('click', closeSettingsPanel);
      applySettings.addEventListener('click', () => {
        rowsCount = clamp(rowsCountInput.value, 1, 10);
        lenPerRow = clamp(lenPerRowInput.value, 1, 20);
        kanaSize = clamp(kanaSizeInput.value, 24, 120);
        setKanaSize(kanaSize);
        newSet();
        closeSettingsPanel();
      });
      resetSettings.addEventListener('click', () => {
        rowsCountInput.value = 1;
        lenPerRowInput.value = 7;
        kanaSizeInput.value = 50;
        rowsCount = 1;
        lenPerRow = 7;
        kanaSize = 50;
        setKanaSize(kanaSize);
        newSet();
      });
      regenBtn.addEventListener('click', newSet);

      backdrop.addEventListener('click', () => {
        closeAlphabetPanel();
        closeSettingsPanel();
      });

      setKanaSize(kanaSize);
      renderAlphabetGrid();
      newSet();
      answerEl.focus();
    })();
  </script>
  <script type="module" src="./js/filter-bridge.js"></script>`r`n</body>
</html>


